<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WormGPT Red Edition - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
  <style>
    :root {
      --primary: #ff003c;
      --primary-dark: #cc002f;
      --primary-light: #ff3366;
      --primary-glow: rgba(255, 0, 60, 0.3);
      --bg: #000000;
      --bg-light: #0a0a0a;
      --surface: #0f0f0f;
      --surface-light: #1a1a1a;
      --surface-lighter: #222222;
      --text: #ffffff;
      --text-secondary: #cccccc;
      --text-tertiary: #888888;
      --border: #333333;
      --success: #00ff88;
      --warning: #ffaa00;
      --info: #4dabf7;
      --glow: 0 0 10px rgba(255, 0, 60, 0.2);
      --glow-strong: 0 0 20px rgba(255, 0, 60, 0.4);
      --gradient: linear-gradient(135deg, var(--primary), var(--primary-dark));
      --gradient-hover: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      -webkit-tap-highlight-color: transparent; 
    }
    
    body { 
      font-family: 'Cairo', sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      height: 100vh; 
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
      line-height: 1.6; 
    }
    
    /* Auth Page */
    .auth-page { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      min-height: 100vh; 
      padding: 20px;
      background: radial-gradient(circle at center, #1a0000 0%, #000000 100%);
    }
    
    .auth-card { 
      background: var(--surface); 
      border: 1px solid var(--border); 
      border-radius: 24px; 
      padding: 40px; 
      max-width: 420px; 
      width: 100%; 
      box-shadow: var(--glow-strong);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    
    .auth-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: var(--gradient);
      opacity: 0.05;
      transform: rotate(45deg);
      pointer-events: none;
    }
    
    .auth-logo { 
      text-align: center; 
      margin-bottom: 30px; 
      position: relative;
    }
    
    .auth-logo .avatar { 
      width: 80px; 
      height: 80px; 
      background: var(--gradient); 
      border-radius: 20px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 36px; 
      font-weight: 800; 
      margin-bottom: 16px; 
      box-shadow: var(--glow-strong);
      transform: rotate(5deg);
      transition: transform 0.3s;
    }
    
    .auth-logo .avatar:hover {
      transform: rotate(0deg) scale(1.05);
    }
    
    .auth-logo h1 { 
      font-size: 32px; 
      font-weight: 800;
    }
    
    .auth-logo h1 span { 
      color: var(--primary);
      text-shadow: 0 0 10px var(--primary-glow);
    }
    
    .auth-logo p { 
      color: var(--text-tertiary); 
      font-size: 14px; 
      margin-top: 4px; 
    }
    
    .auth-title { 
      font-size: 22px; 
      font-weight: 700; 
      text-align: center; 
      margin-bottom: 24px;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .form-group { 
      margin-bottom: 20px; 
    }
    
    .form-group label { 
      display: block; 
      font-size: 14px; 
      color: var(--text-secondary); 
      margin-bottom: 8px; 
      font-weight: 500;
    }
    
    .form-input { 
      width: 100%; 
      padding: 14px 18px; 
      background: var(--surface-light); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      color: var(--text); 
      font-family: 'Cairo', sans-serif; 
      font-size: 15px; 
      outline: none; 
      transition: all 0.3s; 
    }
    
    .form-input:focus { 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px var(--primary-glow);
    }
    
    .auth-btn { 
      width: 100%; 
      padding: 16px; 
      background: var(--gradient); 
      color: white; 
      border: none; 
      border-radius: 12px; 
      font-family: 'Cairo', sans-serif; 
      font-size: 16px; 
      font-weight: 700; 
      cursor: pointer; 
      box-shadow: var(--glow-strong); 
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .auth-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .auth-btn:hover::before {
      left: 100%;
    }
    
    .auth-btn:hover { 
      background: var(--gradient-hover); 
      transform: translateY(-2px);
    }
    
    .auth-btn:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none;
    }
    
    .auth-switch { 
      text-align: center; 
      margin-top: 24px; 
    }
    
    .auth-switch button { 
      background: none; 
      border: none; 
      color: var(--primary); 
      font-family: 'Cairo', sans-serif; 
      cursor: pointer; 
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .auth-switch button:hover {
      text-shadow: 0 0 8px var(--primary-glow);
    }
    
    .auth-error { 
      background: rgba(255,0,60,0.15); 
      border: 1px solid var(--primary); 
      color: var(--primary-light); 
      padding: 12px; 
      border-radius: 10px; 
      font-size: 13px; 
      margin-bottom: 20px; 
      text-align: center; 
      backdrop-filter: blur(5px);
    }
    
    .telegram-info { 
      background: rgba(0,255,136,0.1); 
      border: 1px solid var(--success); 
      color: var(--success); 
      padding: 14px; 
      border-radius: 10px; 
      font-size: 13px; 
      margin-bottom: 20px; 
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    .telegram-info i { 
      margin-left: 8px; 
    }
    
    .verification-group { 
      display: none;
      animation: slideDown 0.3s ease;
    }
    
    .verification-group.show { 
      display: block; 
    }
    
    /* Chat Page */
    .chat-page { 
      display: flex; 
      flex-direction: column; 
      height: 100vh; 
    }
    
    header { 
      background: rgba(0,0,0,0.95); 
      padding: 15px 25px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      border-bottom: 2px solid var(--primary); 
      box-shadow: var(--glow-strong); 
      z-index: 100; 
      min-height: 80px;
      backdrop-filter: blur(10px);
    }
    
    .brand-section { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
    }
    
    .avatar-w { 
      width: 50px; 
      height: 50px; 
      background: var(--gradient); 
      color: white; 
      border-radius: 14px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: 800; 
      font-size: 24px; 
      box-shadow: var(--glow-strong);
      transform: rotate(5deg);
      transition: transform 0.3s;
    }
    
    .avatar-w:hover {
      transform: rotate(0deg) scale(1.05);
    }
    
    .brand-text h1 { 
      font-size: 22px; 
      line-height: 1.2; 
      margin-bottom: 4px; 
      font-weight: 800;
    }
    
    .brand-text h1 span { 
      color: var(--primary);
      text-shadow: 0 0 10px var(--primary-glow);
    }
    
    .brand-text p { 
      font-size: 12px; 
      color: var(--text-tertiary); 
    }
    
    .header-actions { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
    }
    
    .header-btn { 
      width: 44px; 
      height: 44px; 
      background: var(--surface-light); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      color: var(--text-tertiary); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      transition: all 0.3s; 
      font-size: 18px; 
    }
    
    .header-btn:hover { 
      border-color: var(--primary); 
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--glow);
    }
    
    .premium-badge { 
      display: none; 
      background: linear-gradient(135deg, rgba(255,170,0,0.15), rgba(255,170,0,0.05));
      border: 1px solid rgba(255,170,0,0.3); 
      color: var(--warning); 
      padding: 6px 16px; 
      border-radius: 30px; 
      font-size: 13px;
      font-weight: 600;
      backdrop-filter: blur(5px);
    }
    
    .premium-badge.show { 
      display: flex; 
      align-items: center; 
      gap: 6px; 
    }
    
    #chat { 
      flex: 1; 
      overflow-y: auto; 
      padding: 25px; 
      display: flex; 
      flex-direction: column; 
      gap: 20px; 
      background: radial-gradient(circle at center, #1a0000 0%, #000000 100%);
    }
    
    .message-row { 
      display: flex; 
      gap: 15px; 
      align-items: flex-start; 
      animation: fadeInUp 0.4s ease; 
    }
    
    .bot-icon { 
      width: 42px; 
      height: 42px; 
      background: var(--surface-light); 
      border: 1px solid var(--primary); 
      border-radius: 12px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      flex-shrink: 0; 
      color: var(--primary); 
      font-size: 20px;
      box-shadow: var(--glow);
    }
    
    .msg-content { 
      background: var(--surface); 
      padding: 18px; 
      border-radius: 16px; 
      border-right: 4px solid var(--primary); 
      max-width: calc(100% - 60px); 
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .msg-text { 
      font-size: 15px; 
      line-height: 1.7; 
      color: var(--text-secondary); 
      white-space: pre-wrap;
    }
    
    .user-row { 
      justify-content: flex-end; 
      display: flex; 
    }
    
    .user-msg { 
      background: var(--gradient); 
      color: white; 
      padding: 14px 20px; 
      border-radius: 20px 20px 0 20px; 
      max-width: 85%; 
      font-size: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .footer-area { 
      background: rgba(0,0,0,0.95); 
      border-top: 2px solid var(--primary); 
      box-shadow: 0 -5px 25px rgba(255,0,60,0.2); 
      padding: 18px 25px 22px; 
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .model-selector { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 15px; 
      background: var(--surface-light); 
      padding: 12px; 
      border-radius: 14px; 
      border: 1px solid var(--border); 
    }
    
    .model-btn { 
      flex: 1; 
      background: var(--surface-lighter); 
      border: 1px solid var(--border); 
      color: var(--text-tertiary); 
      padding: 12px 8px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-family: 'Cairo', sans-serif; 
      font-size: 14px; 
      font-weight: 600; 
      transition: all 0.3s; 
    }
    
    .model-btn.active { 
      background: var(--gradient); 
      color: white; 
      border-color: var(--primary); 
      box-shadow: var(--glow);
      transform: scale(1.02);
    }
    
    .model-btn:not(.active):hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .input-container { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
    }
    
    .input-wrapper { 
      flex: 1; 
      display: flex; 
      align-items: center; 
      background: var(--surface-light); 
      padding: 4px 20px; 
      border-radius: 16px; 
      border: 1px solid var(--border); 
      transition: all 0.3s;
    }
    
    .input-wrapper:focus-within { 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px var(--primary-glow);
    }
    
    input[type="text"] { 
      flex: 1; 
      background: transparent; 
      border: none; 
      color: var(--text); 
      padding: 14px 8px; 
      font-family: 'Cairo', sans-serif; 
      font-size: 15px; 
      width: 100%; 
      outline: none; 
    }
    
    input[type="text"]::placeholder { 
      color: var(--text-tertiary); 
    }
    
    .send-btn { 
      background: var(--gradient); 
      color: white; 
      border: none; 
      width: 58px; 
      height: 58px; 
      border-radius: 16px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      box-shadow: var(--glow-strong); 
      transition: all 0.3s; 
      font-size: 22px;
    }
    
    .send-btn:hover { 
      transform: translateY(-3px) scale(1.05);
    }
    
    .send-btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none; 
    }
    
    .info-bar { 
      text-align: center; 
      font-size: 13px; 
      color: var(--text-tertiary); 
      margin-top: 15px; 
    }
    
    .info-bar button { 
      background: none; 
      border: none; 
      color: var(--primary); 
      cursor: pointer; 
      font-family: 'Cairo', sans-serif; 
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .info-bar button:hover {
      text-shadow: 0 0 8px var(--primary-glow);
    }
    
    /* Code Blocks */
    .code-block-wrapper {
      margin: 15px 0;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--surface-lighter);
    }
    
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: var(--surface-light);
      border-bottom: 1px solid var(--border);
    }
    
    .code-language {
      color: var(--primary);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .copy-code-btn {
      background: var(--surface-lighter);
      border: 1px solid var(--border);
      color: var(--text-tertiary);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .copy-code-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--surface);
    }
    
    .copy-code-btn.copied {
      background: var(--success);
      color: black;
      border-color: var(--success);
    }
    
    pre {
      margin: 0 !important;
      padding: 15px !important;
      background: #1a1a1a !important;
    }
    
    code {
      font-family: 'Fira Code', monospace !important;
      font-size: 14px !important;
    }
    
    /* Copy Message Button */
    .copy-message-btn {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      transition: all 0.3s;
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    .copy-message-btn:hover {
      color: var(--primary);
      background: var(--surface-light);
    }
    
    /* License Modal */
    .modal-overlay { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.95); 
      z-index: 200; 
      align-items: center; 
      justify-content: center; 
      padding: 20px; 
      backdrop-filter: blur(10px);
    }
    
    .modal-overlay.show { 
      display: flex; 
    }
    
    .modal-card { 
      background: linear-gradient(135deg, var(--surface-light), var(--surface)); 
      border: 2px solid var(--primary); 
      border-radius: 24px; 
      padding: 40px; 
      max-width: 450px; 
      width: 100%; 
      box-shadow: var(--glow-strong); 
      position: relative;
      animation: scaleIn 0.3s ease;
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .modal-close { 
      position: absolute; 
      top: 15px; 
      left: 15px; 
      background: var(--surface-lighter); 
      border: 1px solid var(--border); 
      color: var(--text-tertiary); 
      cursor: pointer; 
      font-size: 18px;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .modal-icon { 
      text-align: center; 
      margin-bottom: 25px; 
    }
    
    .modal-icon .icon-wrap { 
      display: inline-flex; 
      width: 80px; 
      height: 80px; 
      background: rgba(255,0,60,0.15); 
      border-radius: 20px; 
      align-items: center; 
      justify-content: center; 
      font-size: 40px;
      border: 2px solid var(--primary);
    }
    
    .modal-title { 
      text-align: center; 
      font-size: 26px; 
      font-weight: 800; 
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px; 
    }
    
    .modal-desc { 
      text-align: center; 
      color: var(--text-tertiary); 
      font-size: 15px; 
      margin-bottom: 25px; 
    }
    
    .feature-item { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      background: var(--surface-lighter); 
      padding: 12px 18px; 
      border-radius: 14px; 
      border: 1px solid var(--border); 
      margin-bottom: 10px; 
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .feature-item:hover {
      border-color: var(--primary);
      transform: translateX(-5px);
    }
    
    .license-input { 
      width: 100%; 
      padding: 15px; 
      background: var(--surface-light); 
      border: 1px solid var(--border); 
      border-radius: 14px; 
      color: var(--text); 
      font-family: 'Fira Code', monospace; 
      font-size: 16px; 
      text-align: center; 
      letter-spacing: 3px; 
      outline: none; 
      margin: 20px 0; 
    }
    
    .license-input:focus { 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px var(--primary-glow);
    }
    
    /* Hidden */
    .hidden { 
      display: none !important; 
    }
    
    /* Animations */
    @keyframes fadeInUp { 
      from { 
        opacity: 0; 
        transform: translateY(15px); 
      } 
      to { 
        opacity: 1; 
        transform: translateY(0); 
      } 
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .loading-dots { 
      display: inline-flex; 
      gap: 5px; 
    }
    
    .loading-dots span { 
      width: 8px; 
      height: 8px; 
      background: var(--primary); 
      border-radius: 50%; 
      animation: bounce 1.4s infinite ease-in-out; 
    }
    
    .loading-dots span:nth-child(1) { animation-delay: 0s; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes bounce { 
      0%, 60%, 100% { transform: translateY(0); } 
      30% { transform: translateY(-10px); } 
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { 
      width: 8px; 
    }
    
    ::-webkit-scrollbar-track { 
      background: var(--bg); 
    }
    
    ::-webkit-scrollbar-thumb { 
      background: var(--border); 
      border-radius: 4px; 
    }
    
    ::-webkit-scrollbar-thumb:hover { 
      background: var(--primary); 
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .auth-card {
        padding: 30px 20px;
      }
      
      header {
        padding: 12px 15px;
        min-height: 70px;
      }
      
      .brand-text h1 {
        font-size: 18px;
      }
      
      .footer-area {
        padding: 15px;
      }
      
      .model-selector {
        padding: 8px;
      }
      
      .model-btn {
        padding: 10px 5px;
        font-size: 13px;
      }
      
      .msg-content {
        max-width: calc(100% - 50px);
        padding: 14px;
      }
    }
  </style>
</head>
<body>

<!-- ============ AUTH PAGE ============ -->
<div id="authPage" class="auth-page">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="avatar">W</div>
      <h1>Worm<span>GPT</span></h1>
      <p>Red Edition - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
    </div>
    <div class="auth-title" id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div id="authError" class="auth-error hidden"></div>
    
    <!-- Telegram Bot Info -->
    <div class="telegram-info hidden" id="telegramInfo">
      <i class="fab fa-telegram"></i>
      <span id="telegramMessage"></span>
    </div>
    
    <form id="authForm" onsubmit="handleAuth(event)">
      <div class="form-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="authEmail" class="form-input" placeholder="example@email.com" required>
      </div>
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="authPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
      </div>
      
      <!-- Verification Code Field (Ø¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨) -->
      <div class="form-group verification-group" id="verificationGroup">
        <label>Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…</label>
        <input type="text" id="verificationCode" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ù† Ø§Ù„Ø¨ÙˆØª" maxlength="6">
        <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
          <i class="fab fa-telegram"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª: @WormGPT_verify_bot
        </p>
        <button type="button" class="auth-btn" style="margin-top: 10px;" onclick="requestTelegramVerification()">
          <i class="fab fa-telegram"></i> Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
        </button>
      </div>
      
      <button type="submit" class="auth-btn" id="authBtn">Ø¯Ø®ÙˆÙ„</button>
    </form>
    <div class="auth-switch">
      <button onclick="toggleAuthMode()" id="authSwitchBtn">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</button>
    </div>
  </div>
</div>

<!-- ============ CHAT PAGE ============ -->
<div id="chatPage" class="chat-page hidden">
  <header>
    <div class="brand-section">
      <div class="avatar-w">W</div>
      <div class="brand-text">
        <h1>Worm<span>GPT</span></h1>
        <p>Red Edition</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="premium-badge" id="premiumBadge">ğŸ‘‘ Premium</div>
      <button class="header-btn" onclick="openLicenseModal()" title="Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„"><i class="fas fa-key"></i></button>
      <button class="header-btn" onclick="clearChat()" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©"><i class="fas fa-trash"></i></button>
      <button class="header-btn" onclick="handleSignOut()" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <div id="chat">
    <div class="message-row">
      <div class="bot-icon"><i class="fas fa-robot"></i></div>
      <div class="msg-content">
        <div class="msg-text">
          Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong>WormGPT py @Hackerexsos </strong> ğŸ”´<br>
          Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…. Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ!<br><br>
          <span style="color: var(--primary); font-size: 13px;">âœ¨ Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©: Ù†Ø³Ø® Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©ØŒ Ù†Ø³Ø® Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</span>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-area">
    <div class="model-selector">
      <button class="model-btn active" onclick="selectModel('V1', this)">V1 (Ø³Ø±ÙŠØ¹)</button>
      <button class="model-btn" onclick="selectModel('V2', this)">V2 ğŸ‘‘</button>
      <button class="model-btn" onclick="selectModel('V3', this)">V3 ğŸ‘‘</button>
    </div>
    <div class="input-container">
      <div class="input-wrapper">
        <input type="text" id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter')sendMessage()">
      </div>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <i class="fas fa-paper-plane" style="transform:rotate(180deg)"></i>
      </button>
    </div>
    <div class="info-bar">
      <span>WormGPT Red Edition</span> â€¢
      <span id="licenseStatus"><button onclick="openLicenseModal()">ğŸ”‘ ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Premium</button></span>
    </div>
  </div>
</div>

<!-- ============ LICENSE MODAL ============ -->
<div class="modal-overlay" id="licenseModal">
  <div class="modal-card">
    <button class="modal-close" onclick="closeLicenseModal()"><i class="fas fa-times"></i></button>
    <div class="modal-icon"><div class="icon-wrap">ğŸ‘‘</div></div>
    <div class="modal-title" id="licenseTitle">ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Premium</div>
    <div class="modal-desc" id="licenseDesc">Ø§ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>
    <div class="feature-item">âœ¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© V2 Ùˆ V3</div>
    <div class="feature-item">ğŸŒ Ø¨Ø­Ø« Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
    <div class="feature-item">ğŸ“ Ø±ÙØ¹ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
    <div class="feature-item">ğŸ§  Ø°Ø§ÙƒØ±Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù…ØªØ¯Ø©</div>
    <div id="licenseActivation">
      <input type="text" class="license-input" id="licenseKeyInput" placeholder="XXXX-XXXX-XXXX-XXXX" dir="ltr">
      <button class="auth-btn" onclick="activateLicense()" id="activateBtn">ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­</button>
      <p style="text-align:center;font-size:13px;color:var(--text-tertiary);margin-top:15px;">Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ ØªÙØ¹ÙŠÙ„ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
    </div>
    <div id="licensePremiumOk" class="hidden">
      <button class="auth-btn" onclick="closeLicenseModal()">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://ericgpjgmmicasbyhvtn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyaWNncGpnbW1pY2FzYnlodnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMjMxOTUsImV4cCI6MjA4NTY5OTE5NX0.v85Slp5Fx1eP2p6f765IsX9vQLO3uBdYsddPoQODlK4';
const CHAT_ENDPOINT = SUPABASE_URL + '/functions/v1/chat';
const TELEGRAM_BOT_TOKEN = '7278916431:AAF3DKd6fGz_17kLsrE1PeC53Na5S9I_REI'; // Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§
const TELEGRAM_BOT_USERNAME = 'WormGPT1lBOT'; // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¨ÙˆØª

let currentModel = 'V1';
let isLoginMode = true;
let accessToken = null;
let currentUser = null;
let isPremium = false;
let isSending = false;
let pendingVerification = null; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¤Ù‚ØªØ©

// ===== Initialize Clipboard =====
document.addEventListener('DOMContentLoaded', function() {
  initializeClipboard();
});

function initializeClipboard() {
  if (typeof ClipboardJS !== 'undefined') {
    const clipboard = new ClipboardJS('.copy-code-btn, .copy-message-btn', {
      text: function(trigger) {
        if (trigger.classList.contains('copy-code-btn')) {
          const codeBlock = trigger.closest('.code-block-wrapper').querySelector('code');
          return codeBlock ? codeBlock.textContent : '';
        } else if (trigger.classList.contains('copy-message-btn')) {
          const messageDiv = trigger.closest('.msg-content, .user-msg');
          return messageDiv ? messageDiv.querySelector('.msg-text, .user-msg').textContent : '';
        }
        return '';
      }
    });

    clipboard.on('success', function(e) {
      const trigger = e.trigger;
      const originalText = trigger.innerHTML;
      
      if (trigger.classList.contains('copy-code-btn')) {
        trigger.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
        trigger.classList.add('copied');
      } else {
        trigger.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
      }
      
      setTimeout(() => {
        if (trigger.classList.contains('copy-code-btn')) {
          trigger.innerHTML = '<i class="far fa-copy"></i> Ù†Ø³Ø®';
          trigger.classList.remove('copied');
        } else {
          trigger.innerHTML = '<i class="far fa-copy"></i> Ù†Ø³Ø®';
        }
      }, 2000);
      
      e.clearSelection();
    });
  }
}

// ===== Message Copy Function =====
function addCopyButtonToMessage(messageElement, isUser = false) {
  if (!messageElement.querySelector('.copy-message-btn')) {
    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-message-btn';
    copyBtn.innerHTML = '<i class="far fa-copy"></i> Ù†Ø³Ø®';
    copyBtn.setAttribute('data-clipboard-text', messageElement.textContent);
    
    if (isUser) {
      messageElement.appendChild(copyBtn);
    } else {
      const msgContent = messageElement.querySelector('.msg-content');
      if (msgContent) {
        msgContent.style.position = 'relative';
        copyBtn.style.position = 'absolute';
        copyBtn.style.top = '10px';
        copyBtn.style.left = '10px';
        msgContent.appendChild(copyBtn);
      }
    }
  }
}

// ===== Format Code Blocks =====
function formatMessageWithCodeBlocks(message) {
  const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
  let formattedMessage = message;
  let match;
  
  while ((match = codeBlockRegex.exec(message)) !== null) {
    const language = match[1] || 'text';
    const code = match[2].trim();
    
    const codeBlock = `
      <div class="code-block-wrapper">
        <div class="code-header">
          <span class="code-language">${language}</span>
          <button class="copy-code-btn" data-clipboard-text="${escapeHtml(code)}">
            <i class="far fa-copy"></i> Ù†Ø³Ø®
          </button>
        </div>
        <pre><code class="language-${language}">${escapeHtml(code)}</code></pre>
      </div>
    `;
    
    formattedMessage = formattedMessage.replace(match[0], codeBlock);
  }
  
  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø§Ù„Ù‚ØµÙŠØ±Ø©
  const inlineCodeRegex = /`([^`]+)`/g;
  formattedMessage = formattedMessage.replace(inlineCodeRegex, '<code style="background: var(--surface-lighter); padding: 2px 6px; border-radius: 4px; color: var(--primary); font-family: monospace;">$1</code>');
  
  return formattedMessage;
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// ===== Supabase API helpers =====
async function supabaseAuth(endpoint, body) {
  const res = await fetch(SUPABASE_URL + '/auth/v1/' + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
    body: JSON.stringify(body)
  });
  return res.json();
}

async function supabaseQuery(table, options = {}) {
  let url = SUPABASE_URL + '/rest/v1/' + table;
  const params = [];
  if (options.select) params.push('select=' + options.select);
  if (options.filters) params.push(...options.filters);
  if (params.length) url += '?' + params.join('&');
  
  const headers = {
    'apikey': SUPABASE_KEY,
    'Content-Type': 'application/json',
    'Prefer': options.prefer || 'return=representation'
  };
  if (accessToken) headers['Authorization'] = 'Bearer ' + accessToken;
  
  const res = await fetch(url, {
    method: options.method || 'GET',
    headers,
    body: options.body ? JSON.stringify(options.body) : undefined
  });
  return res.json();
}

// ===== Telegram Verification =====
async function sendTelegramCode(chatId) {
  const code = Math.floor(100000 + Math.random() * 900000).toString(); // 6 Ø£Ø±Ù‚Ø§Ù…
  const text = `ğŸ” *Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ WormGPT*\n\nØ§Ù„Ø±Ù…Ø²: *${code}*\n\nâ° Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø³Ø§Ø±ÙŠ Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚\n\nØ¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø²ØŒ ÙŠØ±Ø¬Ù‰ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.`;
  
  try {
    const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: text,
        parse_mode: 'Markdown'
      })
    });
    
    if (!response.ok) throw new Error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚');
    
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    pendingVerification = {
      code: code,
      chatId: chatId,
      expiresAt: Date.now() + 5 * 60 * 1000 // 5 Ø¯Ù‚Ø§Ø¦Ù‚
    };
    
    return true;
  } catch (error) {
    console.error('Telegram error:', error);
    return false;
  }
}

function verifyTelegramCode(inputCode) {
  if (!pendingVerification) return false;
  if (Date.now() > pendingVerification.expiresAt) {
    pendingVerification = null;
    return false;
  }
  return pendingVerification.code === inputCode;
}

// ===== Auth =====
function toggleAuthMode() {
  isLoginMode = !isLoginMode;
  document.getElementById('authTitle').textContent = isLoginMode ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
  document.getElementById('authBtn').textContent = isLoginMode ? 'Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
  document.getElementById('authSwitchBtn').textContent = isLoginMode ? 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹' : 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  document.getElementById('authError').classList.add('hidden');
  document.getElementById('telegramInfo').classList.add('hidden');
  
  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
  const verificationGroup = document.getElementById('verificationGroup');
  if (!isLoginMode) {
    verificationGroup.classList.add('show');
  } else {
    verificationGroup.classList.remove('show');
    document.getElementById('verificationCode').value = '';
    pendingVerification = null;
  }
}

async function handleAuth(e) {
  e.preventDefault();
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  const verificationCode = document.getElementById('verificationCode').value;
  const btn = document.getElementById('authBtn');
  const errorDiv = document.getElementById('authError');
  const telegramInfo = document.getElementById('telegramInfo');
  const telegramMessage = document.getElementById('telegramMessage');
  
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ...';
  errorDiv.classList.add('hidden');
  telegramInfo.classList.add('hidden');
  
  try {
    if (isLoginMode) {
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      const data = await supabaseAuth('token?grant_type=password', { email, password });
      if (data.error) throw new Error(data.error_description || data.msg || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      
      accessToken = data.access_token;
      currentUser = data.user;
      await checkPremiumStatus();
      showChatPage();
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù†Ø·Ù„Ø¨ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø£ÙˆÙ„Ø§Ù‹
      if (!verificationCode) {
        throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…');
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²
      if (!verifyTelegramCode(verificationCode)) {
        throw new Error('Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
      const data = await supabaseAuth('signup', { email, password });
      if (data.error) throw new Error(data.error_description || data.msg || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
      
      // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (pendingVerification && pendingVerification.chatId) {
        try {
          await supabaseQuery('profiles', {
            method: 'POST',
            body: { 
              user_id: data.user.id, 
              telegram_chat_id: pendingVerification.chatId,
              is_premium: false
            }
          });
        } catch (e) {
          console.error('Failed to save Telegram ID:', e);
        }
      }
      
      telegramMessage.textContent = 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      telegramInfo.style.borderColor = 'var(--success)';
      telegramInfo.style.color = 'var(--success)';
      telegramInfo.classList.remove('hidden');
      
      // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      isLoginMode = true;
      document.getElementById('authTitle').textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      document.getElementById('authBtn').textContent = 'Ø¯Ø®ÙˆÙ„';
      document.getElementById('verificationGroup').classList.remove('show');
      document.getElementById('verificationCode').value = '';
      pendingVerification = null;
    }
  } catch (err) {
    errorDiv.textContent = err.message;
    errorDiv.classList.remove('hidden');
  }
  
  btn.disabled = false;
  btn.textContent = isLoginMode ? 'Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
}

// Ø¯Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
async function requestTelegramVerification() {
  const chatId = prompt('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Chat ID):\n(ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† bot @userinfobot)');
  if (!chatId) return;
  
  const telegramInfo = document.getElementById('telegramInfo');
  const telegramMessage = document.getElementById('telegramMessage');
  
  telegramMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚...';
  telegramInfo.classList.remove('hidden');
  
  const success = await sendTelegramCode(chatId);
  
  if (success) {
    telegramMessage.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„Ù‡ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¯Ù†Ø§Ù‡';
    telegramInfo.style.borderColor = 'var(--success)';
    telegramInfo.style.color = 'var(--success)';
  } else {
    telegramMessage.textContent = 'âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    telegramInfo.style.borderColor = 'var(--primary)';
    telegramInfo.style.color = 'var(--primary-light)';
  }
}

async function checkPremiumStatus() {
  if (!currentUser) return;
  try {
    const data = await supabaseQuery('profiles', {
      select: 'is_premium',
      filters: ['user_id=eq.' + currentUser.id]
    });
    isPremium = data && data[0] && data[0].is_premium;
  } catch(e) { 
    isPremium = false; 
  }
  updatePremiumUI();
}

function updatePremiumUI() {
  const badge = document.getElementById('premiumBadge');
  const status = document.getElementById('licenseStatus');
  if (isPremium) {
    badge.classList.add('show');
    status.innerHTML = '<span style="color:var(--warning)"><i class="fas fa-crown"></i> Premium Ù…ÙØ¹Ù„</span>';
  } else {
    badge.classList.remove('show');
    status.innerHTML = '<button onclick="openLicenseModal()"><i class="fas fa-key"></i> ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Premium</button>';
  }
}

function showChatPage() {
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('chatPage').classList.remove('hidden');
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Clipboard Ø¨Ø¹Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„ØµÙØ­Ø©
  setTimeout(initializeClipboard, 500);
}

function clearChat() {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) {
    const chat = document.getElementById('chat');
    chat.innerHTML = `
      <div class="message-row">
        <div class="bot-icon"><i class="fas fa-robot"></i></div>
        <div class="msg-content">
          <div class="msg-text">
            Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong>WormGPT Red Edition</strong> ğŸ”´<br>
            ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ
          </div>
        </div>
      </div>
    `;
  }
}

async function handleSignOut() {
  if (accessToken) {
    await fetch(SUPABASE_URL + '/auth/v1/logout', {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + accessToken }
    }).catch(() => {});
  }
  accessToken = null;
  currentUser = null;
  isPremium = false;
  document.getElementById('chatPage').classList.add('hidden');
  document.getElementById('authPage').classList.remove('hidden');
  document.getElementById('authEmail').value = '';
  document.getElementById('authPassword').value = '';
  document.getElementById('verificationCode').value = '';
  pendingVerification = null;
}

// ===== Chat =====
function selectModel(model, btn) {
  if ((model === 'V2' || model === 'V3') && !isPremium) {
    openLicenseModal();
    return;
  }
  currentModel = model;
  document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

async function sendMessage() {
  const input = document.getElementById('msg');
  const msg = input.value.trim();
  if (!msg || isSending) return;
  
  isSending = true;
  document.getElementById('sendBtn').disabled = true;
  const chat = document.getElementById('chat');
  
  // User message with copy button
  const userMsgId = 'user-' + Date.now();
  chat.innerHTML += '<div class="user-row" id="' + userMsgId + '"><div class="user-msg">' + escapeHtml(msg) + '</div></div>';
  input.value = '';
  
  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù†Ø³Ø® Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  setTimeout(() => {
    const userMsg = document.getElementById(userMsgId);
    if (userMsg) {
      const userMsgDiv = userMsg.querySelector('.user-msg');
      addCopyButtonToMessage(userMsgDiv, true);
    }
    initializeClipboard();
  }, 100);
  
  // Loading
  const loadingId = 'loading-' + Date.now();
  chat.innerHTML += '<div class="message-row" id="' + loadingId + '"><div class="bot-icon"><i class="fas fa-robot"></i></div><div class="msg-content"><div class="msg-text"><div class="loading-dots"><span></span><span></span><span></span></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...</div></div></div>';
  chat.scrollTop = chat.scrollHeight;
  
  try {
    const response = await fetch(CHAT_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + SUPABASE_KEY
      },
      body: JSON.stringify({ 
        message: msg, 
        model: currentModel,
        user_id: currentUser ? currentUser.id : null
      })
    });
    
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
    
    // Remove loading
    const loadEl = document.getElementById(loadingId);
    if (loadEl) loadEl.remove();
    
    // Stream response
    const botId = 'bot-' + Date.now();
    chat.innerHTML += '<div class="message-row" id="' + botId + '"><div class="bot-icon"><i class="fas fa-robot"></i></div><div class="msg-content" style="position: relative;"><div class="msg-text" id="' + botId + '-text"></div><div style="display:flex;justify-content:space-between;margin-top:15px;font-size:12px;color:#888"><span></span><span style="color:var(--primary);font-weight:600"><i class="fas fa-bolt"></i> WormGPT (' + currentModel + ')</span></div></div></div>';
    
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';
    let buffer = '';
    
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      
      let nlIdx;
      while ((nlIdx = buffer.indexOf('\n')) !== -1) {
        let line = buffer.slice(0, nlIdx);
        buffer = buffer.slice(nlIdx + 1);
        if (line.endsWith('\r')) line = line.slice(0, -1);
        if (!line.startsWith('data: ')) continue;
        const jsonStr = line.slice(6).trim();
        if (jsonStr === '[DONE]') continue;
        try {
          const parsed = JSON.parse(jsonStr);
          const content = parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.content;
          if (content) {
            fullText += content;
            document.getElementById(botId + '-text').innerHTML = formatMessageWithCodeBlocks(fullText);
            chat.scrollTop = chat.scrollHeight;
          }
        } catch(e) {}
      }
    }
    
    if (!fullText) {
      document.getElementById(botId + '-text').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯';
    } else {
      // ØªØ·Ø¨ÙŠÙ‚ highlight.js Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
      
      // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù†Ø³Ø® Ù„Ù„Ø±Ø³Ø§Ù„Ø©
      const botMsg = document.getElementById(botId);
      if (botMsg) {
        addCopyButtonToMessage(botMsg);
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Clipboard Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      initializeClipboard();
    }
    
  } catch (err) {
    const loadEl = document.getElementById(loadingId);
    if (loadEl) loadEl.remove();
    chat.innerHTML += '<div class="message-row"><div class="bot-icon"><i class="fas fa-robot"></i></div><div class="msg-content"><div class="msg-text" style="color:var(--primary)">âŒ ' + escapeHtml(err.message) + '</div></div></div>';
  }
  
  isSending = false;
  document.getElementById('sendBtn').disabled = false;
  chat.scrollTop = chat.scrollHeight;
}

// ===== License =====
function openLicenseModal() {
  const modal = document.getElementById('licenseModal');
  const activation = document.getElementById('licenseActivation');
  const premiumOk = document.getElementById('licensePremiumOk');
  
  if (isPremium) {
    document.getElementById('licenseTitle').textContent = 'Ø£Ù†Øª Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù…ÙŠØ²! ğŸ‰';
    document.getElementById('licenseDesc').textContent = 'Ù„Ø¯ÙŠÙƒ ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©';
    activation.classList.add('hidden');
    premiumOk.classList.remove('hidden');
  } else {
    document.getElementById('licenseTitle').textContent = 'ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Premium';
    document.getElementById('licenseDesc').textContent = 'Ø§ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    activation.classList.remove('hidden');
    premiumOk.classList.add('hidden');
  }
  modal.classList.add('show');
}

function closeLicenseModal() {
  document.getElementById('licenseModal').classList.remove('show');
}

async function activateLicense() {
  const keyInput = document.getElementById('licenseKeyInput');
  const key = keyInput.value.trim();
  if (!key) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„'); return; }
  
  const btn = document.getElementById('activateBtn');
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
  
  try {
    // Find key
    const keys = await supabaseQuery('license_keys', {
      select: '*',
      filters: ['key=eq.' + key, 'is_active=eq.true']
    });
    
    if (!keys || !keys.length) throw new Error('Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­');
    const licenseKey = keys[0];
    
    if (licenseKey.expires_at && new Date(licenseKey.expires_at) < new Date()) throw new Error('Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
    if (licenseKey.current_uses >= licenseKey.max_uses) throw new Error('Ø§Ù„Ù…ÙØªØ§Ø­ ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰');
    
    // Check existing activation
    const existing = await supabaseQuery('license_activations', {
      select: 'id',
      filters: ['license_key_id=eq.' + licenseKey.id, 'user_id=eq.' + currentUser.id]
    });
    if (existing && existing.length) throw new Error('Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† Ù‚Ø¨Ù„');
    
    // Create activation
    await supabaseQuery('license_activations', {
      method: 'POST',
      body: { license_key_id: licenseKey.id, user_id: currentUser.id }
    });
    
    // Update uses
    await fetch(SUPABASE_URL + '/rest/v1/license_keys?id=eq.' + licenseKey.id, {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + accessToken,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({ current_uses: licenseKey.current_uses + 1 })
    });
    
    // Update profile
    await fetch(SUPABASE_URL + '/rest/v1/profiles?user_id=eq.' + currentUser.id, {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + accessToken,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({ is_premium: true })
    });
    
    isPremium = true;
    updatePremiumUI();
    
    // Show success message
    const telegramInfo = document.getElementById('telegramInfo');
    const telegramMessage = document.getElementById('telegramMessage');
    telegramMessage.textContent = 'âœ… ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ğŸ‰';
    telegramInfo.style.borderColor = 'var(--success)';
    telegramInfo.style.color = 'var(--success)';
    telegramInfo.classList.remove('hidden');
    
    setTimeout(() => {
      telegramInfo.classList.add('hidden');
    }, 5000);
    
    closeLicenseModal();
    
  } catch (err) {
    alert(err.message);
  }
  
  btn.disabled = false;
  btn.textContent = 'ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­';
}

// Click outside modal to close
document.getElementById('licenseModal').addEventListener('click', function(e) {
  if (e.target === this) closeLicenseModal();
});

// ===== Handle paste for license key =====
document.getElementById('licenseKeyInput')?.addEventListener('paste', function(e) {
  e.preventDefault();
  const pastedText = e.clipboardData.getData('text');
  this.value = pastedText.trim();
});

// ===== Initialize on load =====
window.addEventListener('load', function() {
  // Check if user is already logged in (optional)
  // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…Ø®Ø²Ù† Ù‡Ù†Ø§
});
</script>
</body>
</html>
