<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>WormGPT Red Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --primary: #ff003c;
      --primary-dark: #cc002f;
      --primary-light: #ff3366;
      --bg: #000000;
      --bg-light: #0a0a0a;
      --surface: #0f0f0f;
      --surface-light: #1a1a1a;
      --surface-lighter: #222222;
      --text: #ffffff;
      --text-secondary: #cccccc;
      --text-tertiary: #888888;
      --border: #333333;
      --success: #00ff88;
      --warning: #ffaa00;
      --info: #4dabf7;
      --glow: 0 0 10px rgba(255, 0, 60, 0.2);
      --glow-strong: 0 0 20px rgba(255, 0, 60, 0.4);
      --safe-area-inset: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
      -webkit-overflow-scrolling: touch;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      line-height: 1.5;
    }

    /* Auth Page - Ù…Ø­Ø³Ù† Ù„Ù„Ù‡Ø§ØªÙ */
    .auth-page {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: 12px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .auth-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px 20px;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--glow);
      margin: auto;
    }

    .auth-logo {
      text-align: center;
      margin-bottom: 20px;
    }

    .auth-logo .avatar {
      width: 70px;
      height: 70px;
      background: var(--primary);
      border-radius: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 12px;
      box-shadow: var(--glow-strong);
    }

    .auth-logo h1 {
      font-size: 32px;
      line-height: 1.2;
    }

    .auth-logo h1 span {
      color: var(--primary);
    }

    .auth-logo p {
      color: var(--text-tertiary);
      font-size: 13px;
      margin-top: 4px;
    }

    .auth-title {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      padding: 16px;
      background: var(--surface-light);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      color: var(--text);
      font-family: 'Cairo', sans-serif;
      font-size: 15px;
      outline: none;
      transition: all 0.2s;
    }

    .form-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,0,60,0.1);
    }

    .auth-btn {
      width: 100%;
      padding: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 16px;
      font-family: 'Cairo', sans-serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: var(--glow-strong);
      transition: all 0.2s;
      margin-top: 8px;
    }

    .auth-btn:active {
      transform: scale(0.98);
      background: var(--primary-dark);
    }

    .auth-btn:disabled {
      opacity: 0.5;
      transform: none;
    }

    /* Telegram Verification - Ù…Ø­Ø³Ù† */
    .verification-section {
      margin-top: 20px;
      padding: 20px 16px;
      background: rgba(255,0,60,0.03);
      border: 1.5px dashed var(--primary);
      border-radius: 20px;
    }

    .verification-title {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 16px;
    }

    .verification-steps {
      list-style: none;
      margin-bottom: 20px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .verification-steps li {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      background: rgba(255,255,255,0.02);
      padding: 10px;
      border-radius: 12px;
    }

    .verification-steps i {
      color: var(--primary);
      width: 20px;
      text-align: center;
    }

    .bot-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--primary);
      color: white;
      padding: 14px;
      border-radius: 14px;
      text-decoration: none;
      font-size: 14px;
      font-weight: bold;
      margin: 16px 0;
      width: 100%;
    }

    .code-input-group {
      display: flex;
      gap: 10px;
      margin: 16px 0;
    }

    .code-input {
      flex: 1;
      background: var(--surface-light);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      padding: 14px;
      font-family: 'Cairo', monospace;
      font-size: 18px;
      text-align: center;
      letter-spacing: 4px;
      font-weight: bold;
    }

    .verify-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 0 20px;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
    }

    .resend-link {
      color: var(--primary);
      font-size: 13px;
      text-align: center;
      display: block;
      margin-top: 12px;
    }

    /* Chat Page - Ù…Ø­Ø³Ù† Ù„Ù„Ù‡Ø§ØªÙ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø³Ù„Ø³ */
    .chat-page {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: radial-gradient(circle at center, #0a0000 0%, #000000 100%);
    }

    header {
      background: var(--bg);
      padding: 12px 16px;
      padding-top: env(safe-area-inset-top, 12px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1.5px solid var(--border);
      box-shadow: var(--glow);
      z-index: 10;
      flex-shrink: 0;
    }

    .brand-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar-w {
      width: 48px;
      height: 48px;
      background: var(--primary);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 22px;
      box-shadow: var(--glow);
      flex-shrink: 0;
    }

    .brand-text h1 {
      font-size: 20px;
      line-height: 1.2;
    }

    .brand-text p {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-btn {
      width: 44px;
      height: 44px;
      background: var(--surface-light);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 18px;
    }

    .header-btn:active {
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(0.95);
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    .message-row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      animation: fadeInUp 0.3s ease;
    }

    .bot-icon {
      width: 42px;
      height: 42px;
      background: var(--surface-light);
      border: 1.5px solid var(--primary);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: var(--primary);
      font-size: 18px;
    }

    .msg-content {
      background: var(--surface);
      padding: 16px;
      border-radius: 18px;
      border-right: 4px solid var(--primary);
      max-width: calc(100% - 54px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .msg-text {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .user-row {
      justify-content: flex-end;
      display: flex;
    }

    .user-msg {
      background: var(--primary);
      color: white;
      padding: 14px 18px;
      border-radius: 18px 18px 4px 18px;
      max-width: 85%;
      font-size: 15px;
      box-shadow: 0 4px 12px rgba(255,0,60,0.2);
      word-break: break-word;
    }

    .footer-area {
      background: var(--bg);
      border-top: 2px solid var(--primary);
      box-shadow: 0 -5px 20px rgba(255,0,60,0.15);
      padding: 12px 16px;
      padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
      flex-shrink: 0;
    }

    .model-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      background: var(--surface-light);
      padding: 8px;
      border-radius: 18px;
      border: 1.5px solid var(--border);
    }

    .model-btn {
      flex: 1;
      background: var(--surface-lighter);
      border: 1.5px solid var(--border);
      color: var(--text-tertiary);
      padding: 12px 4px;
      border-radius: 14px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
      text-align: center;
    }

    .model-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: var(--glow);
    }

    .tools-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tool-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--surface-light);
      border: 1.5px solid var(--border);
      color: var(--text-tertiary);
      padding: 14px 8px;
      border-radius: 16px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      transition: all 0.2s;
    }

    .tool-btn:active {
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(0.98);
    }

    .file-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,0,60,0.1);
      border: 1.5px solid rgba(255,0,60,0.3);
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .input-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      background: var(--surface-light);
      padding: 4px 16px;
      border-radius: 18px;
      border: 1.5px solid var(--border);
    }

    .input-wrapper:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,0,60,0.1);
    }

    input[type="text"] {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      padding: 16px 8px;
      font-family: 'Cairo', sans-serif;
      font-size: 15px;
      width: 100%;
      outline: none;
    }

    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow-strong);
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .send-btn:active {
      transform: scale(0.95);
      background: var(--primary-dark);
    }

    .info-bar {
      text-align: center;
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 12px;
      padding: 4px;
    }

    /* Modal Ù…Ø­Ø³Ù† */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 16px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .modal-card {
      background: linear-gradient(135deg, var(--surface-light), var(--surface));
      border: 2px solid var(--primary);
      border-radius: 28px;
      padding: 32px 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--glow-strong);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loading-dots {
      display: inline-flex;
      gap: 6px;
    }

    .loading-dots span {
      width: 10px;
      height: 10px;
      background: var(--primary);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-12px); }
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

<!-- ============ AUTH PAGE ============ -->
<div id="authPage" class="auth-page">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="avatar">W</div>
      <h1>Worm<span>GPT</span></h1>
      <p>Red Edition - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</p>
    </div>
    <div class="auth-title" id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div id="authError" class="auth-error hidden"></div>
    
    <!-- Login Form -->
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="loginEmail" class="form-input" placeholder="example@email.com" required>
      </div>
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="loginPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
      </div>
      <button type="submit" class="auth-btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    </form>

    <!-- Register Form -->
    <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
      <div class="form-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="regEmail" class="form-input" placeholder="example@email.com" required onchange="requestTelegramCode()">
      </div>
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="regPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
      </div>
      
      <!-- Telegram Verification Section -->
      <div class="verification-section">
        <div class="verification-title">
          <i class="fab fa-telegram"></i>
          <span>Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± ØªÙ„ÙŠØ¬Ø±Ø§Ù…</span>
        </div>
        <ul class="verification-steps">
          <li><i class="fas fa-1-circle"></i> Ø§ÙØªØ­ Ø¨ÙˆØª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</li>
          <li><i class="fas fa-2-circle"></i> Ø£Ø±Ø³Ù„ Ø£Ù…Ø± /start</li>
          <li><i class="fas fa-3-circle"></i> Ø§Ù†ØªØ¸Ø± Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</li>
        </ul>
        
        <a href="https://t.me/WormGPT1lBOT" target="_blank" class="bot-link">
          <i class="fab fa-telegram"></i>
          @WormGPT1lBOT
        </a>
        
        <div class="code-input-group">
          <input type="text" id="verificationCode" class="code-input" placeholder="000000" maxlength="6" pattern="[0-9]{6}" inputmode="numeric">
          <button type="button" class="verify-btn" id="verifyCodeBtn" onclick="verifyTelegramCode()">ØªØ­Ù‚Ù‚</button>
        </div>
        <div id="verificationStatus" style="font-size: 13px; text-align: center;"></div>
        <button type="button" class="resend-link" id="resendCodeBtn" onclick="requestTelegramCode()">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</button>
      </div>
      
      <button type="submit" class="auth-btn" id="registerBtn" disabled>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </form>

    <div class="auth-switch">
      <button onclick="toggleAuthMode()" id="authSwitchBtn">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</button>
    </div>
  </div>
</div>

<!-- ============ CHAT PAGE ============ -->
<div id="chatPage" class="chat-page hidden">
  <header>
    <div class="brand-section">
      <div class="avatar-w">W</div>
      <div class="brand-text">
        <h1>Worm<span>GPT</span></h1>
        <p>Red Edition</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="premium-badge" id="premiumBadge">ğŸ‘‘ Premium</div>
      <button class="header-btn" onclick="openLicenseModal()" title="Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„"><i class="fas fa-key"></i></button>
      <button class="header-btn" onclick="handleSignOut()" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <div id="chat">
    <div class="message-row">
      <div class="bot-icon"><i class="fas fa-robot"></i></div>
      <div class="msg-content">
        <div class="msg-text">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong>WormGPT Red Edition</strong> ğŸ”´<br>Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…. Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ!</div>
      </div>
    </div>
  </div>

  <div class="footer-area">
    <div class="model-selector">
      <button class="model-btn active" onclick="selectModel('V1', this)">V1</button>
      <button class="model-btn" onclick="selectModel('V2', this)">V2 ğŸ‘‘</button>
      <button class="model-btn" onclick="selectModel('V3', this)">V3 ğŸ‘‘</button>
    </div>
    <div class="tools-bar">
      <button class="tool-btn" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-paperclip"></i> Ø±ÙØ¹ Ù…Ù„Ù
      </button>
      <input type="file" id="fileInput" accept=".txt,.js,.py,.html,.css,.json" style="display:none" onchange="handleFileUpload(event)">
    </div>
    <div class="file-indicator hidden" id="fileIndicator">
      <i class="fas fa-file-code" style="color:var(--primary)"></i>
      <span id="fileNameDisplay"></span>
      <button class="remove-file" onclick="removeFile()">âœ•</button>
    </div>
    <div class="input-container">
      <div class="input-wrapper">
        <input type="text" id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter')sendMessage()">
      </div>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <i class="fas fa-paper-plane" style="transform:rotate(180deg)"></i>
      </button>
    </div>
    <div class="info-bar">
      <span id="userCount">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: 0</span> â€¢ 
      <span id="licenseStatus"><button onclick="openLicenseModal()">ğŸ”‘ Premium</button></span>
    </div>
  </div>
</div>

<!-- ============ LICENSE MODAL ============ -->
<div class="modal-overlay" id="licenseModal" onclick="if(event.target===this) closeLicenseModal()">
  <div class="modal-card">
    <button class="modal-close" onclick="closeLicenseModal()" style="position:absolute; top:16px; left:16px; background:none; border:none; color:var(--text-tertiary); font-size:24px;">âœ•</button>
    <div class="modal-icon" style="text-align:center; margin-bottom:20px;">
      <div style="display:inline-block; width:70px; height:70px; background:rgba(255,0,60,0.1); border-radius:20px; line-height:70px; font-size:40px;">ğŸ‘‘</div>
    </div>
    <div class="modal-title" style="font-size:24px; font-weight:bold; color:var(--primary); text-align:center; margin-bottom:8px;" id="licenseTitle">ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Premium</div>
    <div class="modal-desc" style="text-align:center; color:var(--text-tertiary); margin-bottom:24px;" id="licenseDesc">Ø§ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>
    <div style="background:var(--surface-lighter); padding:14px; border-radius:16px; border:1px solid var(--border); margin-bottom:10px;">âœ¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© V2 Ùˆ V3</div>
    <div style="background:var(--surface-lighter); padding:14px; border-radius:16px; border:1px solid var(--border); margin-bottom:10px;">ğŸ“ Ø±ÙØ¹ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
    <div style="background:var(--surface-lighter); padding:14px; border-radius:16px; border:1px solid var(--border); margin-bottom:20px;">ğŸ§  Ø°Ø§ÙƒØ±Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù…ØªØ¯Ø©</div>
    
    <div id="licenseActivation">
      <input type="text" class="license-input" id="licenseKeyInput" placeholder="XXXX-XXXX-XXXX" style="width:100%; padding:16px; background:var(--surface-light); border:2px solid var(--border); border-radius:16px; color:var(--text); text-align:center; font-family:monospace; margin-bottom:16px;">
      <button class="auth-btn" onclick="activateLicense()" id="activateBtn">ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­</button>
    </div>
    
    <div id="licensePremiumOk" class="hidden">
      <button class="auth-btn" onclick="closeLicenseModal()">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
</div>

<script>
// ============ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ============
const SUPABASE_URL = 'https://ericgpjgmmicasbyhvtn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyaWNncGpnbW1pY2FzYnlodnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMjMxOTUsImV4cCI6MjA4NTY5OTE5NX0.v85Slp5Fx1eP2p6f765IsX9vQLO3uBdYsddPoQODlK4';
const CHAT_ENDPOINT = SUPABASE_URL + '/functions/v1/chat';

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…
const TELEGRAM_BOT_TOKEN = '7278916431:AAF3DKd6fGz_17kLsrE1PeC53Na5S9I_REI'; // Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§
const TELEGRAM_BOT_USERNAME = 'WormGPT1lBOT';
const ADMIN_CHAT_ID = '7845383853'; // Ø¶Ø¹ Ù…Ø¹Ø±Ù Ø§Ù„Ø£Ø¯Ù…Ù† Ù‡Ù†Ø§

// ============ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ============
let currentModel = 'V1';
let isLoginMode = true;
let accessToken = null;
let currentUser = null;
let isPremium = false;
let isSending = false;
let attachedFileContent = null;
let attachedFileName = null;

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚
let pendingVerification = {
  email: null,
  code: null,
  expiresAt: null,
  verified: false,
  telegramChatId: null
};

// Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
let userStats = {
  totalUsers: 0,
  newUsers24h: 0,
  lastReset: Date.now()
};

// ============ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ============
async function loadUserStats() {
  try {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† LocalStorage
    const saved = localStorage.getItem('wormgpt_stats');
    if (saved) {
      userStats = JSON.parse(saved);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø±ÙˆØ± 24 Ø³Ø§Ø¹Ø©
      if (Date.now() - userStats.lastReset > 24 * 60 * 60 * 1000) {
        await sendDailyReport();
        userStats.newUsers24h = 0;
        userStats.lastReset = Date.now();
        saveUserStats();
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ Ù…Ù† Supabase
    const { count } = await supabaseQuery('profiles', {
      select: 'count',
      filters: ['select=count']
    });
    if (count) userStats.totalUsers = count;
    
    updateUserCountDisplay();
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

function saveUserStats() {
  localStorage.setItem('wormgpt_stats', JSON.stringify(userStats));
}

function updateUserCountDisplay() {
  const element = document.getElementById('userCount');
  if (element) {
    element.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${userStats.totalUsers} (${userStats.newUsers24h}+ Ø¬Ø¯ÙŠØ¯)`;
  }
}

async function incrementUserCount() {
  userStats.totalUsers++;
  userStats.newUsers24h++;
  saveUserStats();
  updateUserCountDisplay();
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù† Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
  await sendAdminNotification('Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯', `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯!\nğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${pendingVerification.email}\nğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${userStats.totalUsers}\nğŸ†• Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…: ${userStats.newUsers24h}`);
}

async function sendAdminNotification(title, message) {
  if (TELEGRAM_BOT_TOKEN === 'YOUR_BOT_TOKEN' || ADMIN_CHAT_ID === 'ADMIN_CHAT_ID') return;
  
  try {
    const telegramApiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    const text = `ğŸ”” *${title}*\n\n${message}\n\nğŸ• ${new Date().toLocaleString('ar-SA')}`;
    
    await fetch(telegramApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: ADMIN_CHAT_ID,
        text: text,
        parse_mode: 'Markdown'
      })
    });
  } catch (error) {
    console.error('Error sending admin notification:', error);
  }
}

async function sendDailyReport() {
  if (TELEGRAM_BOT_TOKEN === 'YOUR_BOT_TOKEN' || ADMIN_CHAT_ID === 'ADMIN_CHAT_ID') return;
  
  try {
    const telegramApiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    const report = `ğŸ“Š *ØªÙ‚Ø±ÙŠØ± WormGPT Ø§Ù„ÙŠÙˆÙ…ÙŠ*\n\n` +
                   `ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${userStats.totalUsers}\n` +
                   `ğŸ†• Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¬Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…: ${userStats.newUsers24h}\n` +
                   `â­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†: ${await getPremiumCount()}\n` +
                   `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}\n` +
                   `ğŸ• Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ar-SA')}`;
    
    await fetch(telegramApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: ADMIN_CHAT_ID,
        text: report,
        parse_mode: 'Markdown'
      })
    });
  } catch (error) {
    console.error('Error sending daily report:', error);
  }
}

async function getPremiumCount() {
  try {
    const data = await supabaseQuery('profiles', {
      select: 'count',
      filters: ['is_premium=eq.true', 'select=count']
    });
    return data.count || 0;
  } catch {
    return 0;
  }
}

// ============ Ø¯ÙˆØ§Ù„ Supabase ============
async function supabaseAuth(endpoint, body) {
  const res = await fetch(SUPABASE_URL + '/auth/v1/' + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
    body: JSON.stringify(body)
  });
  return res.json();
}

async function supabaseQuery(table, options = {}) {
  let url = SUPABASE_URL + '/rest/v1/' + table;
  const params = [];
  if (options.select) params.push('select=' + options.select);
  if (options.filters) params.push(...options.filters);
  if (params.length) url += '?' + params.join('&');
  
  const headers = {
    'apikey': SUPABASE_KEY,
    'Content-Type': 'application/json',
    'Prefer': options.prefer || 'return=representation'
  };
  if (accessToken) headers['Authorization'] = 'Bearer ' + accessToken;
  
  const res = await fetch(url, {
    method: options.method || 'GET',
    headers,
    body: options.body ? JSON.stringify(options.body) : undefined
  });
  return res.json();
}

// ============ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± ØªÙ„ÙŠØ¬Ø±Ø§Ù… ============
async function requestTelegramCode() {
  const email = document.getElementById('regEmail').value;
  if (!email) {
    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  const statusDiv = document.getElementById('verificationStatus');
  const resendBtn = document.getElementById('resendCodeBtn');
  
  resendBtn.disabled = true;
  statusDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚...';
  
  try {
    const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
    const expiresAt = Date.now() + 10 * 60 * 1000;
    
    pendingVerification = {
      email: email,
      code: verificationCode,
      expiresAt: expiresAt,
      verified: false,
      telegramChatId: null
    };

    // Ù„Ù„ØªØ¬Ø±Ø¨Ø© - Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    const demoChatId = prompt('Ù„Ù„ØªØ¬Ø±Ø¨Ø©: Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:');
    if (demoChatId) {
      pendingVerification.telegramChatId = demoChatId;
      
      if (TELEGRAM_BOT_TOKEN !== 'YOUR_BOT_TOKEN') {
        const telegramApiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        const message = `ğŸ” *Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ*\n\nØ§Ù„Ø±Ù…Ø²: *${verificationCode}*\n\nØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚.\n\nğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${email}`;
        
        const response = await fetch(telegramApiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: demoChatId,
            text: message,
            parse_mode: 'Markdown'
          })
        });
        
        const result = await response.json();
        if (result.ok) {
          statusDiv.style.color = 'var(--success)';
          statusDiv.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…';
        } else {
          throw new Error(result.description);
        }
      } else {
        // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
        alert(`[ØªØ¬Ø±ÙŠØ¨ÙŠ] Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚: ${verificationCode}`);
        statusDiv.style.color = 'var(--success)';
        statusDiv.textContent = 'âœ… [ØªØ¬Ø±ÙŠØ¨ÙŠ] ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø²';
      }
    }
  } catch (error) {
    statusDiv.style.color = 'var(--primary)';
    statusDiv.textContent = 'âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²';
    console.error(error);
  }
  
  resendBtn.disabled = false;
}

async function verifyTelegramCode() {
  const codeInput = document.getElementById('verificationCode');
  const statusDiv = document.getElementById('verificationStatus');
  const registerBtn = document.getElementById('registerBtn');
  
  const enteredCode = codeInput.value.trim();
  
  if (!enteredCode || enteredCode.length !== 6) {
    statusDiv.style.color = 'var(--primary)';
    statusDiv.textContent = 'âŒ Ø§Ù„Ø±Ù…Ø² ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 6 Ø£Ø±Ù‚Ø§Ù…';
    return;
  }
  
  if (!pendingVerification.code || Date.now() > pendingVerification.expiresAt) {
    statusDiv.style.color = 'var(--primary)';
    statusDiv.textContent = 'âŒ Ø§Ù„Ø±Ù…Ø² Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
    return;
  }
  
  if (enteredCode === pendingVerification.code) {
    pendingVerification.verified = true;
    registerBtn.disabled = false;
    statusDiv.style.color = 'var(--success)';
    statusDiv.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­';
    codeInput.disabled = true;
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø£Ø¯Ù…Ù†
    await sendAdminNotification('âœ… ØªØ­Ù‚Ù‚ Ù†Ø§Ø¬Ø­', `ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\nğŸ“§ ${pendingVerification.email}`);
  } else {
    statusDiv.style.color = 'var(--primary)';
    statusDiv.textContent = 'âŒ Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­';
  }
}

// ============ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ============
function toggleAuthMode() {
  isLoginMode = !isLoginMode;
  document.getElementById('authTitle').textContent = isLoginMode ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
  document.getElementById('loginForm').classList.toggle('hidden', !isLoginMode);
  document.getElementById('registerForm').classList.toggle('hidden', isLoginMode);
  document.getElementById('authSwitchBtn').textContent = isLoginMode ? 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹' : 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  
  if (!isLoginMode) {
    // Reset registration form
    document.getElementById('regEmail').value = '';
    document.getElementById('regPassword').value = '';
    document.getElementById('verificationCode').value = '';
    document.getElementById('registerBtn').disabled = true;
    pendingVerification = { verified: false };
  }
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const btn = document.getElementById('loginBtn');
  const errorDiv = document.getElementById('authError');
  
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ...';
  
  try {
    const data = await supabaseAuth('token?grant_type=password', { email, password });
    if (data.error) throw new Error(data.error_description || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    
    accessToken = data.access_token;
    currentUser = data.user;
    await checkPremiumStatus();
    showChatPage();
    
    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    await sendAdminNotification('ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„', `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${email}\nğŸ• ${new Date().toLocaleString()}`);
    
  } catch (err) {
    errorDiv.textContent = err.message;
    errorDiv.classList.remove('hidden');
  }
  
  btn.disabled = false;
  btn.textContent = 'Ø¯Ø®ÙˆÙ„';
}

async function handleRegister(e) {
  e.preventDefault();
  
  if (!pendingVerification.verified) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  const email = document.getElementById('regEmail').value;
  const password = document.getElementById('regPassword').value;
  const btn = document.getElementById('registerBtn');
  const errorDiv = document.getElementById('authError');
  
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
  
  try {
    const data = await supabaseAuth('signup', { 
      email, 
      password,
      options: { 
        data: { 
          telegram_verified: true,
          telegram_chat_id: pendingVerification.telegramChatId,
          registered_at: new Date().toISOString()
        } 
      } 
    });
    
    if (data.error) throw new Error(data.error_description || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    await incrementUserCount();
    
    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
    await sendAdminNotification('ğŸ‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:\nğŸ“§ ${email}\nğŸ†” ${pendingVerification.telegramChatId}`);
    
    errorDiv.textContent = 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!';
    errorDiv.style.color = 'var(--success)';
    errorDiv.style.background = 'rgba(0,255,136,0.1)';
    errorDiv.classList.remove('hidden');
    
    setTimeout(() => {
      toggleAuthMode();
    }, 2000);
    
  } catch (err) {
    errorDiv.textContent = err.message;
    errorDiv.style.color = 'var(--primary-light)';
    errorDiv.style.background = 'rgba(255,0,60,0.1)';
    errorDiv.classList.remove('hidden');
  }
  
  btn.disabled = false;
  btn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
}

async function checkPremiumStatus() {
  if (!currentUser) return;
  try {
    const data = await supabaseQuery('profiles', {
      select: 'is_premium',
      filters: ['user_id=eq.' + currentUser.id]
    });
    isPremium = data && data[0] && data[0].is_premium;
  } catch(e) { isPremium = false; }
  updatePremiumUI();
}

function updatePremiumUI() {
  const status = document.getElementById('licenseStatus');
  if (isPremium) {
    document.getElementById('premiumBadge').classList.add('show');
    status.innerHTML = 'ğŸ‘‘ Premium';
  } else {
    document.getElementById('premiumBadge').classList.remove('show');
    status.innerHTML = '<button onclick="openLicenseModal()" style="background:none; border:none; color:var(--primary);">ğŸ”‘ Premium</button>';
  }
}

function showChatPage() {
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('chatPage').classList.remove('hidden');
}

async function handleSignOut() {
  if (accessToken) {
    await fetch(SUPABASE_URL + '/auth/v1/logout', {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + accessToken }
    }).catch(() => {});
  }
  accessToken = null;
  currentUser = null;
  isPremium = false;
  document.getElementById('chatPage').classList.add('hidden');
  document.getElementById('authPage').classList.remove('hidden');
}

// ============ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ============
function selectModel(model, btn) {
  if ((model === 'V2' || model === 'V3') && !isPremium) {
    openLicenseModal();
    return;
  }
  currentModel = model;
  document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (!isPremium) { openLicenseModal(); return; }
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    attachedFileContent = ev.target.result.slice(0, 5000);
    attachedFileName = file.name;
    document.getElementById('fileNameDisplay').textContent = 'ğŸ“ ' + file.name;
    document.getElementById('fileIndicator').classList.remove('hidden');
  };
  reader.readAsText(file);
}

function removeFile() {
  attachedFileContent = null;
  attachedFileName = null;
  document.getElementById('fileIndicator').classList.add('hidden');
}

async function sendMessage() {
  const input = document.getElementById('msg');
  const msg = input.value.trim();
  if (!msg || isSending) return;
  
  isSending = true;
  document.getElementById('sendBtn').disabled = true;
  const chat = document.getElementById('chat');
  
  // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  chat.innerHTML += '<div class="user-row"><div class="user-msg">' + escapeHtml(msg) + (attachedFileName ? ' ğŸ“' + escapeHtml(attachedFileName) : '') + '</div></div>';
  
  const sentFileContent = attachedFileContent;
  input.value = '';
  removeFile();
  
  // Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
  const loadingId = 'loading-' + Date.now();
  chat.innerHTML += '<div class="message-row" id="' + loadingId + '"><div class="bot-icon"><i class="fas fa-robot"></i></div><div class="msg-content"><div class="msg-text"><div class="loading-dots"><span></span><span></span><span></span></div></div></div></div>';
  chat.scrollTop = chat.scrollHeight;
  
  try {
    const response = await fetch(CHAT_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + SUPABASE_KEY
      },
      body: JSON.stringify({ 
        message: msg, 
        model: currentModel,
        file: sentFileContent
      })
    });
    
    document.getElementById(loadingId).remove();
    
    if (!response.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
    
    const data = await response.json();
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
    chat.innerHTML += '<div class="message-row"><div class="bot-icon"><i class="fas fa-robot"></i></div><div class="msg-content"><div class="msg-text">' + escapeHtml(data.reply || data.message || 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…') + '</div></div></div>';
    
  } catch (err) {
    document.getElementById(loadingId).remove();
    chat.innerHTML += '<div class="message-row"><div class="bot-icon"><i class="fas fa-robot"></i></div><div class="msg-content"><div class="msg-text" style="color:var(--primary)">âŒ ' + escapeHtml(err.message) + '</div></div></div>';
  }
  
  isSending = false;
  document.getElementById('sendBtn').disabled = false;
  chat.scrollTop = chat.scrollHeight;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„ ============
function openLicenseModal() {
  document.getElementById('licenseModal').classList.add('show');
}

function closeLicenseModal() {
  document.getElementById('licenseModal').classList.remove('show');
}

async function activateLicense() {
  const key = document.getElementById('licenseKeyInput').value.trim();
  if (!key) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­'); return; }
  
  const btn = document.getElementById('activateBtn');
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„...';
  
  try {
    // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    if (key.length < 8) throw new Error('Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­');
    
    isPremium = true;
    updatePremiumUI();
    
    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø§Ù„ØªÙØ¹ÙŠÙ„
    await sendAdminNotification('â­ ØªÙØ¹ÙŠÙ„ Premium', `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser?.email}\nğŸ”‘ Ø§Ù„Ù…ÙØªØ§Ø­: ${key}`);
    
    alert('âœ… ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
    closeLicenseModal();
    
  } catch (err) {
    alert(err.message);
  }
  
  btn.disabled = false;
  btn.textContent = 'ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­';
}

// ============ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ============
document.addEventListener('DOMContentLoaded', async () => {
  await loadUserStats();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ
  setInterval(async () => {
    if (Date.now() - userStats.lastReset > 24 * 60 * 60 * 1000) {
      await sendDailyReport();
      userStats.newUsers24h = 0;
      userStats.lastReset = Date.now();
      saveUserStats();
    }
  }, 60 * 60 * 1000); // ÙØ­Øµ ÙƒÙ„ Ø³Ø§Ø¹Ø©
  
  // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
  document.getElementById('loginForm').classList.remove('hidden');
  document.getElementById('registerForm').classList.add('hidden');
});
</script>
</body>
</html>
